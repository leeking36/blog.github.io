---
layout: post
title: vue3 开发指南
anchor: blog09
excerpt: 保姆级快速上手指南
update: 2023年09月19日
---

## 获取 this

- Vue2 中每个组件里使用 this 都指向当前组件实例，this 上还包含了全局挂载的东西、路由、状态管理等啥啥都有。
- 而 Vue3 中没有 this，如果想要类似的用法，有两种，一是获取当前组件实例，二是获取全局实例。

```json
<script setup>
  import { getCurrentInstance } from 'vue'
  // proxy 就是当前组件实例
  // appContext.config.globalProperties就是全局实例，含全局的路由、状态管理、全局组件等
  const { proxy, appContext } = getCurrentInstance()

  // 实际上大部分情况下只需要使用proxy就可以了
  // proxy.$http 全局自定义属性
  // proxy.$router
  // proxy.$route
  // proxy.$pinia
</script>
```

### Vue3 getCurrentInstance 与 ts 结合使用的坑

#### 问题

```json
<script lang="ts" setup>
  import { getCurrentInstance } from 'vue'
  // 首先 此处 proxy ts会报
  // 类型“ComponentInternalInstance | null”上不存在属性“proxy”。ts(2339)
  const { proxy } = getCurrentInstance()
  // 然后下面会报这个错误
  // Unsafe member access .$axios on an `any` value.  eslint@typescript-eslint/no-unsafe-member-access
  // Unsafe call of an `any` typed value.  eslint@typescript-eslint/no-unsafe-call
  proxy.$axios('')
</script>
```

#### 解决方法

第一个报错很好理解 因为 getCurrentInstance()的返回类型存在 null 所以在此处添加断言即可

```javascript
import { ComponentInternalInstance, getCurrentInstance } from 'vue'
// 添加断言
const { proxy, appContext } = getCurrentInstance() as ComponentInternalInstance
```

但是改完后我们发现下面依旧会有报错

```javascript
// 对象可能为 "null"。ts(2531)
proxy.$axios("");
```

这个解决起来更简单了，在 proxy 后面添加?来过滤 null 的结果

```javascript
proxy?.$axios("");
```

#### 关于在 ts 中使用到类型定义错误问题

`报错：...类型“ComponentInternalInstance | null”`
解决 1：可以添加 ts 忽略去解决

```javascript
// @ts-ignore
const { proxy } = getCurrentInstance();
```

解决 2：考虑到在获取上下文和全局挂载实例的时候会用到这个 getCurrentInstance，那我们来新建 hooks\useCurrentInstance.ts

```javascript
  import { ComponentInternalInstance, getCurrentInstance } from 'vue'
  export default function useCurrentInstance() {
  const { appContext } = getCurrentInstance() as ComponentInternalInstance
  const globalProperties = appContext.config.globalProperties
  return {
    globalProperties
  }
}
```

组件中使用：

```javascript
// 先引入文件
import useCurrentInstance from "@/hooks/useCurrentInstance";
// 在setup 中使用处理
const { globalProperties } = useCurrentInstance();
```

#### 不能使用 getCurrentInstance 的 ctx

```javascript
//错误写法，ctx打包后在生产环境下是获取不到的
const { ctx } = getCurrentInstance();
//正确写法
const { proxy } = getCurrentInstance();
```

## 全局注册(属性/方法)
